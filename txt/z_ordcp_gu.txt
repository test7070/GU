z_ordcp_gu01:--z_ordcp_gu01

declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_quatno nvarchar(30)
declare @t_contract nvarchar(30)

set @t_btggno = case when '#non'=[3] then '' else [3] end
set @t_etggno = case when '#non'=[4] then char(255) else [4] end
set @t_quatno = case when '#non' = [5] then '' else [5] end
set @t_contract = case when '#non' = [6] then '' else [6] end
--------------------------------------------------------------------------------

SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	
	c_serial nvarchar(10),
	c_email nvarchar(100),
	c_addr1 nvarchar(max),
	c_addr2 nvarchar(max),
	c_tel nvarchar(50),
	c_fax nvarchar(50),
	
	rec int,
	tgg nvarchar(100),
	quatno nvarchar(30),
	trandate nvarchar(10),
	product nvarchar(100),
	mount float,
	price float
)

insert into @tmp
select '2',c.serial,c.email,c.addr,c.addr_invo,a.tel,a.fax,ROW_NUMBER() over (order by a.tgg),a.tgg,a.quatno,a.trandate,b.product,b.mount,b.price
from view_ordc a
left join view_ordcs b on a.noa = b.noa
left join acomp c on a.cno = c.noa
where (a.tggno between @t_btggno and @t_etggno) and (LEN(@t_quatno) = 0 or a.quatno = @t_quatno) and (LEN(@t_contract) = 0 or a.contract = @t_contract)

declare @rec int
declare @tgg nvarchar(30)
declare @xtgg nvarchar(30)
declare @quatno nvarchar(30)
declare @xquatno nvarchar(30)

set @xtgg = 'xxxxxxxxxxxxx'
set @xquatno = 'xxxxxxxxxxxxx'

declare cursor_table cursor for 
select rec,tgg,quatno from @tmp order by quatno
open cursor_table 
fetch next from cursor_table 
into @rec,@tgg,@quatno 
while(@@FETCH_STATUS <> -1) 
begin
	if(@tgg != @xtgg)
	begin
		insert into @tmp(gno,c_serial,c_email,c_addr1,c_addr2,c_tel,c_fax,tgg)
		select '0',c_serial,c_email,c_addr1,c_addr2,c_tel,c_fax,tgg from @tmp where rec = @rec 
		insert into @tmp(gno,tgg,quatno)
		values('3',@tgg,'zzzzzzzzzzzzz')
	end
	
	if(@quatno != @xquatno)
	begin
		insert into @tmp(gno,tgg,quatno,trandate)
		select '1',tgg,quatno,trandate from @tmp where gno = '2' and rec = @rec
	end

	set @xtgg = @tgg
	set @xquatno = @quatno

	fetch next from cursor_table 
	into @rec,@tgg,@quatno
end 
close cursor_table 
deallocate cursor_table 

insert into @tmp(gno,quatno,mount)
select '9',quatno,SUM(mount) from @tmp where gno = '2' group by quatno


declare @min int
set @xquatno = 'xxxxxxxxxxxxx'

declare cursor_table cursor for 
select rec,quatno from @tmp where gno = '2' order by quatno
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno 
while(@@FETCH_STATUS <> -1) 
begin

	if(@quatno != @xquatno)
	begin
		set @min = (select MIN(rec) from @tmp where gno = '2' and quatno = @quatno)
	end
	if(@min = @rec)
	begin
		update @tmp set mount = (select mount from @tmp where gno = '9' and quatno = @quatno) where rec = @rec
	end
	else if(@min < @rec)
	begin
		update @tmp set mount = null where rec = @rec
	end

	set @xquatno = @quatno

	fetch next from cursor_table 
	into @rec,@quatno
end 
close cursor_table 
deallocate cursor_table 

delete @tmp where gno = '9'

select 
	gno,c_serial,c_email,c_addr1,c_addr2,c_tel,c_fax,
	tgg,quatno,trandate,product,dbo.getComma(mount,-1) mount,dbo.getComma(price,-1) price 
from @tmp order by tgg,quatno,gno  ;



--******************************************************************************
z_ordcp_gu02:--z_ordcp_gu02

declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_quatno nvarchar(30)
declare @t_contract nvarchar(30)

set @t_btggno = case when '#non'=[3] then '' else [3] end
set @t_etggno = case when '#non'=[4] then char(255) else [4] end
set @t_quatno = case when '#non' = [5] then '' else [5] end
set @t_contract = case when '#non' = [6] then '' else [6] end
--------------------------------------------------------------------------------

SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	rec int,
	quatno nvarchar(30),
	tgg nvarchar(100),
	trandate nvarchar(10),
	product nvarchar(100),
	price float
)

insert into @tmp
select '0',ROW_NUMBER() over (order by a.quatno,a.tgg),a.quatno,c.nick + '-',a.trandate,b.product,b.price
from view_ordc a
left join view_ordcs b on a.noa = b.noa
left join tgg c on a.tggno = c.noa  
where(a.quatno is not null) and (a.tggno between @t_btggno and @t_etggno) and
	 (LEN(@t_quatno) = 0 or a.quatno = @t_quatno) and (LEN(@t_contract) = 0 or a.contract = @t_contract)
order by a.quatno,a.tgg

declare @rec int
declare @quatno nvarchar(30)
declare @xquatno nvarchar(30)
declare @tgg nvarchar(100)
declare @xtgg nvarchar(100)
declare @min int

set @xquatno = 'xxxxxxxxxx'
set @xtgg = 'xxxxxxxxxx'

declare cursor_table cursor for 
select rec,quatno,tgg from @tmp order by quatno,tgg
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno,@tgg 
while(@@FETCH_STATUS <> -1) 
begin
	if(@tgg != @xtgg)
	begin
		set @min = (select MIN(rec) from @tmp where quatno = @quatno and tgg = @tgg)		
	end
	if(@min < @rec)
	begin
		update @tmp set tgg = '' where rec = @rec
	end
	
	set @xquatno = @quatno
	set @xtgg = @tgg

	fetch next from cursor_table 
	into @rec,@quatno,@tgg	
end 
close cursor_table 
deallocate cursor_table 

declare @cnt int
declare @max int

set @cnt = 0
set @xquatno = 'xxxxxxxxxx'

declare cursor_table cursor for 
select rec,quatno from @tmp where gno = '0' order by quatno
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno 
while(@@FETCH_STATUS <> -1) 
begin
	if(@quatno != @xquatno)
	begin 
		set @cnt = 0
		set @max = (select MAX(rec) from @tmp where gno = '0' and quatno = @quatno)
	end
	
	set @cnt = @cnt + 1
	
	if(@cnt % 36 = 0 or @rec = @max)
	begin
		insert into @tmp(gno,rec,quatno)
		select '1',rec,quatno from @tmp where rec = @rec 
	end
	
	set @xquatno = @quatno
	
	fetch next from cursor_table
	into @rec,@quatno
end 
close cursor_table 
deallocate cursor_table


select gno,rec,quatno,tgg,trandate,product,dbo.getComma(price,-1) price from @tmp order by quatno,rec,gno ;