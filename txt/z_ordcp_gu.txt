z_ordcp_gu01:--z_ordcp_gu01

declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_quatno nvarchar(30)
declare @t_contract nvarchar(30)

set @t_btggno = case when '#non'=[3] then '' else [3] end
set @t_etggno = case when '#non'=[4] then char(255) else [4] end
set @t_quatno = case when '#non' = [5] then '' else [5] end
set @t_contract = case when '#non' = [6] then '' else [6] end
--------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	
	c_serial nvarchar(10),
	c_email nvarchar(100),
	c_addr1 nvarchar(max),
	c_addr2 nvarchar(max),
	c_tel nvarchar(50),
	c_fax nvarchar(50),
	
	rec int,
	tgg nvarchar(100),
	quatno nvarchar(30),
	trandate nvarchar(10),
	product nvarchar(100),
	mount float,
	price float
)

insert into @tmp
select '2',c.serial,c.email,c.addr,c.addr_invo,a.tel,a.fax,ROW_NUMBER() over (order by a.tgg),a.tgg,a.quatno,a.trandate,b.product,b.mount,b.price
from view_ordc a
left join view_ordcs b on a.noa = b.noa
left join acomp c on a.cno = c.noa
where (a.tggno between @t_btggno and @t_etggno) and (a.quatno is not null) and
	  (LEN(@t_quatno) = 0 or a.quatno = @t_quatno) and (LEN(@t_contract) = 0 or a.contract = @t_contract)

declare @rec int
declare @tgg nvarchar(30)
declare @xtgg nvarchar(30)
declare @quatno nvarchar(30)
declare @xquatno nvarchar(30)

set @xtgg = 'xxxxxxxxxxxxx'
set @xquatno = 'xxxxxxxxxxxxx'

declare cursor_table cursor for 
select rec,tgg,quatno from @tmp order by quatno
open cursor_table 
fetch next from cursor_table 
into @rec,@tgg,@quatno 
while(@@FETCH_STATUS <> -1) 
begin
	if(@tgg != @xtgg)
	begin
		insert into @tmp(gno,c_serial,c_email,c_addr1,c_addr2,c_tel,c_fax,tgg)
		select '0',c_serial,c_email,c_addr1,c_addr2,c_tel,c_fax,tgg from @tmp where rec = @rec 
		insert into @tmp(gno,tgg,quatno,trandate)
		select '1',tgg,quatno,trandate from @tmp where gno = '2' and rec = @rec
		insert into @tmp(gno,tgg,quatno)
		values('3',@tgg,'zzzzzzzzzzzzz')
	end

	set @xtgg = @tgg
	set @xquatno = @quatno

	fetch next from cursor_table 
	into @rec,@tgg,@quatno
end 
close cursor_table 
deallocate cursor_table 

insert into @tmp(gno,quatno,mount)
select '9',quatno,SUM(mount) from @tmp where gno = '2' group by quatno


declare @min int
set @xquatno = 'xxxxxxxxxxxxx'

declare cursor_table cursor for 
select rec,quatno from @tmp where gno = '2' order by quatno
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno 
while(@@FETCH_STATUS <> -1) 
begin

	if(@quatno != @xquatno)
	begin
		set @min = (select MIN(rec) from @tmp where gno = '2' and quatno = @quatno)
	end
	if(@min = @rec)
	begin
		update @tmp set mount = (select mount from @tmp where gno = '9' and quatno = @quatno) where rec = @rec
	end
	else if(@min < @rec)
	begin
		update @tmp set mount = null where rec = @rec
	end

	set @xquatno = @quatno

	fetch next from cursor_table 
	into @rec,@quatno
end 
close cursor_table 
deallocate cursor_table 

delete @tmp where gno = '9'

select 
	gno,c_serial,c_email,c_addr1,c_addr2,c_tel,c_fax,
	tgg,quatno,trandate,product,dbo.getComma(mount,-1) mount,dbo.getComma(price,-1) price 
from @tmp order by tgg,quatno,gno  ;



--******************************************************************************
z_ordcp_gu02:--z_ordcp_gu02

declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_quatno nvarchar(30)
declare @t_contract nvarchar(30)

set @t_btggno = case when '#non'=[3] then '' else [3] end
set @t_etggno = case when '#non'=[4] then char(255) else [4] end
set @t_quatno = case when '#non' = [5] then '' else [5] end
set @t_contract = case when '#non' = [6] then '' else [6] end
--------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	rec int,
	quatno nvarchar(30),
	tggno nvarchar(100),
	tgg nvarchar(100),
	trandate nvarchar(10),
	q_productno nvarchar(100),
	q_product nvarchar(max),
	product nvarchar(100),
	spec1 nvarchar(100),
	spec2 nvarchar(100),
	price float
)

insert into @tmp
select '9',ROW_NUMBER() over (partition by a.quatno order by a.quatno,a.tggno),a.quatno,a.tggno,e.nick+'-',a.trandate,b.productno,REPLACE(b.product,'~#$~#$','"'),c.product,d.spec,c.spec,b.price
from view_ordc a
left join view_ordcs b on a.noa = b.noa
left join ucas c on b.productno = c.noa
left join ucc d on b.productno = d.noa
left join tgg e on a.tggno = e.noa  
where(a.quatno is not null) and (a.tggno between @t_btggno and @t_etggno) and
	 (LEN(@t_quatno) = 0 or a.quatno = @t_quatno) and (LEN(@t_contract) = 0 or a.contract = @t_contract)
order by a.quatno,a.tgg

insert into @tmp (gno,quatno,tggno,tgg,trandate)
select '1',max(quatno),MAX(tggno),MAX(tgg),MAX(trandate) from @tmp group by quatno,tggno

update @tmp set gno = case when product is not null then '7' else '8' end where gno = '9'
update @tmp set product = dbo.split(dbo.split(product,':',1),' ',0) where gno = '7'

update @tmp set product = q_product where gno = '8'
update @tmp set spec2 = spec1 where gno = '8'

--
declare @gno nvarchar(1)
declare @rec int
declare @quatno nvarchar(30)
declare @q_productno nvarchar(30)
declare @q_product nvarchar(100)
declare @q_xproductno nvarchar(30)  
declare @product nvarchar(100)
declare @xproduct nvarchar(100)
declare @str nvarchar(100)
declare @cnt int
declare @i int
declare @no int

set @q_xproductno = 'xxxxxx'
set @xproduct = 'xxxxxx'
set @no = 0

declare cursor_table cursor for 
select gno,rec,quatno,q_productno,q_product,product from @tmp where gno = '7' or gno = '8'
open cursor_table 
fetch next from cursor_table 
into @gno,@rec,@quatno,@q_productno,@q_product,@product
while(@@FETCH_STATUS <> -1) 
begin	
	if(@product != @xproduct)
	begin 	
		set @no = @no +1
		if (@gno = '7')
		begin
			set @cnt = (select COUNT(*) from @tmp where gno = '7' and product = @product)
			set @i = 0
			set @str = ''
			while(@i < @cnt)
			begin
				if(@i = 0)
				begin
					set @str = @str + (select spec2 from @tmp where gno = '7' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1	
				end	
				else
				begin	
					set @str = @str + '-' + (select spec2 from @tmp where gno = '7' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1
				end
			end		
			
			insert into @tmp(gno,rec,quatno,tggno,tgg,trandate,q_productno,q_product,product,spec1)
			select '0',@no,quatno,tggno,tgg,trandate,@q_productno,@q_product+':',@product+':',@str from @tmp where gno = '1'
		end	
		else if (@gno = '8')
		begin
			set @cnt = (select COUNT(*) from @tmp where gno = '8' and product = @product)
			set @i = 0
			set @str = ''
			while(@i < @cnt)
			begin
				if(@i = 0)
				begin
					set @str = @str + (select spec2 from @tmp where gno = '8' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1	
				end	
				else
				begin	
					set @str = @str + '-' + (select spec2 from @tmp where gno = '8' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1
				end
			end		
			
			insert into @tmp(gno,rec,quatno,tggno,tgg,trandate,q_productno,q_product,spec1)
			select '0',@no,quatno,tggno,tgg,trandate,@q_productno,@q_product+':',@str from @tmp where gno = '1'
		end	
		
	end
		
	set @q_xproductno = @q_productno
	set @xproduct = @product
	
	fetch next from cursor_table 
	into @gno,@rec,@quatno,@q_productno,@q_product,@product	
end 
close cursor_table 
deallocate cursor_table 
 
delete @tmp where gno = '1' or gno = '7' or gno = '8'
update @tmp set tgg = '' where rec != 1

--
declare @xquatno nvarchar(30)
declare @q_xproduct nvarchar(100)
declare @min int
declare @len int

set @xquatno = 'xxxxxx'
set @q_xproduct = 'xxxxxx'

declare cursor_table cursor for 
select rec,quatno,q_product from @tmp
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno,@q_product 
while(@@FETCH_STATUS <> -1) 
begin
	if(@q_product != @q_xproduct)
	begin
		set @min = (select MIN(rec) from @tmp where quatno = @quatno and q_product = @q_product)
		set @len = LEN(@q_product)	
	end
	if(@min < @rec)
	begin
		update @tmp set q_product = REPLICATE('&nbsp',@len) where rec = @rec and quatno = @quatno and q_product = @q_product
	end
	
	set @xquatno = @quatno
	set @q_xproduct = @q_product

	fetch next from cursor_table 
	into @rec,@quatno,@q_product
end 
close cursor_table 
deallocate cursor_table 

--
declare @max int

set @cnt = 0
set @xquatno = 'xxxxxxxxxx'

declare cursor_table cursor for 
select rec,quatno from @tmp where gno = '0' order by quatno
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno 
while(@@FETCH_STATUS <> -1) 
begin
	if(@quatno != @xquatno)
	begin 
		set @cnt = 0
		set @max = (select MAX(rec) from @tmp where gno = '0' and quatno = @quatno)
	end
	set @cnt = @cnt + 1
	if(@cnt % 30 = 0 or @rec = @max)
	begin
		insert into @tmp(gno,rec,quatno)
		select '1',rec,quatno from @tmp where rec = @rec 
	end
	
	set @xquatno = @quatno
	
	fetch next from cursor_table
	into @rec,@quatno
end 
close cursor_table 
deallocate cursor_table

select gno,rec,quatno,tgg,trandate,q_product,product,spec1,dbo.getComma(price,-1) price from @tmp order by quatno,rec ;



--******************************************************************************
z_ordcp_gu03:--z_ordcp_gu03

declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_quatno nvarchar(30)
declare @t_contract nvarchar(30)

set @t_btggno = case when '#non'=[3] then '' else [3] end
set @t_etggno = case when '#non'=[4] then char(255) else [4] end
set @t_quatno = case when '#non' = [5] then '' else [5] end
set @t_contract = case when '#non' = [6] then '' else [6] end
--------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	rec int,
	quatno nvarchar(30),
	tggno nvarchar(100),
	tgg nvarchar(100),
	trandate nvarchar(10),
	q_productno nvarchar(100),
	q_product nvarchar(max),
	product nvarchar(100),
	spec1 nvarchar(100),
	spec2 nvarchar(100),
	price float
)

insert into @tmp
select '9',ROW_NUMBER() over (partition by a.quatno order by a.quatno,a.tggno),a.quatno,a.tggno,e.nick+'-',a.trandate,b.productno,REPLACE(b.product,'~#$~#$','"'),c.product,d.spec,c.spec,b.price
from view_ordc a
left join view_ordcs b on a.noa = b.noa
left join ucas c on b.productno = c.noa
left join ucc d on b.productno = d.noa
left join tgg e on a.tggno = e.noa  
where(a.quatno is not null) and (a.tggno between @t_btggno and @t_etggno) and
	 (LEN(@t_quatno) = 0 or a.quatno = @t_quatno) and (LEN(@t_contract) = 0 or a.contract = @t_contract)
order by a.quatno,a.tgg

insert into @tmp (gno,quatno,tggno,tgg,trandate)
select '1',max(quatno),MAX(tggno),MAX(tgg),MAX(trandate) from @tmp group by quatno,tggno

update @tmp set gno = case when product is not null then '7' else '8' end where gno = '9'
update @tmp set product = dbo.split(dbo.split(product,':',1),' ',0) where gno = '7'

update @tmp set product = q_product where gno = '8'
update @tmp set spec2 = spec1 where gno = '8'

--
declare @gno nvarchar(1)
declare @rec int
declare @quatno nvarchar(30)
declare @q_productno nvarchar(30)
declare @q_product nvarchar(100)
declare @q_xproductno nvarchar(30)  
declare @product nvarchar(100)
declare @xproduct nvarchar(100)
declare @str nvarchar(100)
declare @cnt int
declare @i int
declare @no int

set @q_xproductno = 'xxxxxx'
set @xproduct = 'xxxxxx'
set @no = 0

declare cursor_table cursor for 
select gno,rec,quatno,q_productno,q_product,product from @tmp where gno = '7' or gno = '8'
open cursor_table 
fetch next from cursor_table 
into @gno,@rec,@quatno,@q_productno,@q_product,@product
while(@@FETCH_STATUS <> -1) 
begin	
	if(@product != @xproduct)
	begin 	
		set @no = @no +1
		if (@gno = '7')
		begin
			set @cnt = (select COUNT(*) from @tmp where gno = '7' and product = @product)
			set @i = 0
			set @str = ''
			while(@i < @cnt)
			begin
				if(@i = 0)
				begin
					set @str = @str + (select spec2 from @tmp where gno = '7' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1	
				end	
				else
				begin	
					set @str = @str + '-' + (select spec2 from @tmp where gno = '7' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1
				end
			end		
			
			insert into @tmp(gno,rec,quatno,tggno,tgg,trandate,q_productno,q_product,product,spec1)
			select '0',@no,quatno,tggno,tgg,trandate,@q_productno,@q_product+':',@product+':',@str from @tmp where gno = '1'
		end	
		else if (@gno = '8')
		begin
			set @cnt = (select COUNT(*) from @tmp where gno = '8' and product = @product)
			set @i = 0
			set @str = ''
			while(@i < @cnt)
			begin
				if(@i = 0)
				begin
					set @str = @str + (select spec2 from @tmp where gno = '8' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1	
				end	
				else
				begin	
					set @str = @str + '-' + (select spec2 from @tmp where gno = '8' and rec = @rec+@i and quatno = @quatno and product = @product)
					set @i = @i +1
				end
			end		
			
			insert into @tmp(gno,rec,quatno,tggno,tgg,trandate,q_productno,q_product,spec1)
			select '0',@no,quatno,tggno,tgg,trandate,@q_productno,@q_product+':',@str from @tmp where gno = '1'
		end	
		
	end
		
	set @q_xproductno = @q_productno
	set @xproduct = @product
	
	fetch next from cursor_table 
	into @gno,@rec,@quatno,@q_productno,@q_product,@product	
end 
close cursor_table 
deallocate cursor_table 
 
delete @tmp where gno = '1' or gno = '7' or gno = '8'
update @tmp set tgg = '' where rec != 1

--
declare @xquatno nvarchar(30)
declare @q_xproduct nvarchar(100)
declare @min int
declare @len int

set @xquatno = 'xxxxxx'
set @q_xproduct = 'xxxxxx'

declare cursor_table cursor for 
select rec,quatno,q_product from @tmp
open cursor_table 
fetch next from cursor_table 
into @rec,@quatno,@q_product 
while(@@FETCH_STATUS <> -1) 
begin
	if(@q_product != @q_xproduct)
	begin
		set @min = (select MIN(rec) from @tmp where quatno = @quatno and q_product = @q_product)
		set @len = LEN(@q_product)	
	end
	if(@min < @rec)
	begin
		update @tmp set q_product = REPLICATE('&nbsp',@len) where rec = @rec and quatno = @quatno and q_product = @q_product
	end
	
	set @xquatno = @quatno
	set @q_xproduct = @q_product

	fetch next from cursor_table 
	into @rec,@quatno,@q_product
end 
close cursor_table 
deallocate cursor_table 

--
update @tmp set gno = '1' where rec = 1
update @tmp set gno = '2' where rec != 1

select gno,rec,quatno,tgg,trandate,q_product,product,spec1,dbo.getComma(price,-1) price from @tmp order by quatno,rec ;