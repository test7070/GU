z_invop_gu01:--z_invop_gu01

declare @t_noa nvarchar(30)

set @t_noa = case when '#non' = [2] then '' else [2] end
---------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	rec int,	
	
	noa nvarchar(30),
	datea nvarchar(10),
	invoice nvarchar(100),
	comp nvarchar(50),
	addr nvarchar(max),
	shipped nvarchar(50),
	per nvarchar(50),
	sailing nvarchar(50),
	froma nvarchar(50),
	toa nvarchar(50),
	bank nvarchar(1),
	lcno nvarchar(30),
	lcdated nvarchar(1),
	
	itemno nvarchar(100),
	description nvarchar(200),
	quantity float,
	price float,
	amount float,
	
	main nvarchar(max),
	side nvarchar(max),
	memo nvarchar(max)
)

insert into @tmp
select 
	'2',ROW_NUMBER() over (partition by a.noa order by a.noa),
	a.contract,a.datea,a.title,a.comp,a.addr,a.shipped,a.per,a.sailing,a.froma,a.toa,c.negotiatingbank,c.lcno,c.lcdated,
	b.productno,REPLACE(b.description,'~#$~#$','"'),b.quantity,price,b.amount,
	REPLACE(d.main,'chr(10)','<br>'),REPLACE(REPLACE(d.side,'~#$',"'"),'chr(10)','<br>'),c.invoicememo
from invo a	
left join invos b on a.noa = b.noa
left join ordei c on a.noa = c.noa
left join boaj d on a.vccno = d.noa
where (a.noa = @t_noa)

--控制換行
declare @rec nvarchar(30)
declare @noa nvarchar(30)
declare @xnoa nvarchar(30)
declare @cnt int
declare @max int

set @xnoa = 'xxxxxxxxxx'

declare cursor_table cursor for 
select rec,noa from @tmp where gno = '2' order by noa
open cursor_table 
fetch next from cursor_table 
into @rec,@noa
while(@@FETCH_STATUS <> -1) 
begin
	if(@noa != @xnoa)
	begin 
		insert into @tmp(gno,rec,noa,datea,invoice,comp,addr,shipped,per,froma,toa,lcno)
		select '1',rec,noa,datea,invoice,comp,addr,shipped,per,froma,toa,lcno from @tmp where rec = @rec
		
		set @cnt = 0
		set @max = (select MAX(rec) from @tmp where gno = '2' and noa = @noa)
	end
	
	set @cnt = @cnt + 1

	if(@cnt % 30 = 0 and @rec != @max)
	begin
		insert into @tmp(gno,rec,noa)
		select '3',rec,noa from @tmp where rec = @rec
		insert into @tmp(gno,rec,noa,datea,invoice,comp,addr,shipped,per,froma,toa,lcno)
		select '1',@rec+1,noa,datea,invoice,comp,addr,shipped,per,froma,toa,lcno from @tmp where rec = @rec and gno = '2'
	end
	
	
	set @xnoa = @noa
	
	fetch next from cursor_table
	into @rec,@noa
end 
close cursor_table 
deallocate cursor_table

insert into @tmp(gno,rec,noa,quantity,amount)
select '4',MAX(rec),noa,SUM(quantity),SUM(amount)
from @tmp where gno = '2' group by noa

insert into @tmp(gno,rec,noa,datea,main,side,memo)
select '5',MAX(rec),MAX(noa),MAX(datea),MAX(main),MAX(side),MAX(memo)
from @tmp where gno = '2' group by noa

select 
	gno,rec,noa,datea,invoice,comp,addr,shipped,per,sailing,froma,toa,bank,lcno,lcdated,itemno,description,
	dbo.getComma(quantity,0) quantity,dbo.getComma(price,2) price,dbo.getComma(amount,2) amount,main,side,memo
from @tmp order by noa,rec,gno ;
